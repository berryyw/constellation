## 目标与范围
- 用大模型生成更丰富、可读性强的星座运势，替代当前随机文案
- 保留现有接口与数据结构以兼容前端；新增“富文本/详情”字段以支持你截图中的分栏内容
- 提供一致性与回退机制：当模型不可用时，自动回退到本地随机生成

## 接入方案
- 支持多提供商：可接入腾讯混元、OpenAI、阿里通义等，采用可插拔客户端
- 通过环境变量配置：`LLM_PROVIDER`、`LLM_API_KEY`、`LLM_MODEL`、`LLM_BASE_URL`、`LLM_TIMEOUT`、`LLM_CACHE_TTL`
- 在微信云托管环境安全注入密钥，不在代码或日志中暴露

## 接口设计
- 保留现有：`GET /api/horoscope?date&constellation`（默认：本地/或切到模型）
- 新增富文本：`GET /api/horoscope/rich?date&constellation`（总览+各分栏详细解读）
- 响应示例（富文本）：
  - 基础数值：`overall,love,career,wealth,health,study,social`（1-5）
  - 指标：`healthIndex, negotiationIndex`
  - 其他：`luckyColor, luckyNumber, matchConstellation, title`
  - 分栏：`sections.overall, sections.love, sections.career, sections.wealth, sections.health`（每栏 150-250 字）

## Prompt 设计
- 系统：你是资深占星师，输出严格的 JSON，字段含上面定义，不要多余文本
- 用户：`{date, constellation, locale: "zh-CN", style: "温暖积极、具体建议"}`
- 要求：
  - 星级为 1-5 的整数，文案避免空话，给出具体行为建议
  - `title` 类似“左右逢源的节奏”风格主题
  - `luckyColor`、`luckyNumber`、`matchConstellation`符合常识

## 一致性与缓存
- 以 `key = ${date}-${constellation}` 做 24h 缓存，避免重复计费与结果漂移
- 可选：在请求中注入 `seed`（同 key）提示模型保持稳定风格
- 失败或超时：回退到本地生成（你当前逻辑保留，不影响使用）

## 稳定性与治理
- 超时与重试：`LLM_TIMEOUT`，失败后重试一次；再失败则回退
- 速率限制：`express-rate-limit` 基于 IP 或用户标识，防滥用
- 观测：请求/响应简要审计（不含密钥），错误原因分级统计

## 安全与合规
- 绝不打印 API Key；密钥通过环境变量注入
- 前端不可直接调用模型接口，所有调用走后端，避免密钥泄露
- 对生成结果做基本清洗（长度、敏感词过滤）

## 代码改造点
- `server/clients/llmClient.js`：封装不同提供商调用与统一返回结构
- `server/prompts/horoscopePrompt.js`：集中维护提示词模板
- `server/routes/horoscopeRich.js`：新增 `/api/horoscope/rich` 路由
- `server/server.js`：注册新路由；在原 `/api/horoscope` 增加切换到 LLM 的开关（如 `USE_LLM=true`）

## 前端适配
- 保留现有 `fetchHoroscope` 用于简版
- 新增 `fetchHoroscopeRich` 调用 `/api/horoscope/rich`，渲染分栏内容
- 不改动首页与入口逻辑；仅在结果页面增加“详情”展示（支持你的截图样式）

## 部署与验证
- 设置云托管环境变量：`LLM_PROVIDER, LLM_API_KEY, LLM_MODEL, USE_LLM=true`
- 本地与云端分别验证：
  - 无键：回退正常；有键：返回富文本
  - 相同 `date+constellation` 返回一致内容；跨日变更
- 压测与费用：打开缓存后每日相同请求几乎零额外调用

## 回滚计划
- 一键关闭：`USE_LLM=false` 即恢复当前随机模式
- 发生异常时自动回退，不影响用户体验

## 交付物
- 新路由与客户端模块、提示词模板、缓存与速率限制、中英文注释的环境变量示例（不含密钥）
- 简单单元测试（用 mock LLM），以及接口联调脚本